"use strict";L.LineUtil.PolylineDecorator={computeAngle:function(a,b){return 180*Math.atan2(b.y-a.y,b.x-a.x)/Math.PI+90},getPointPathPixelLength:function(pts){var nbPts=pts.length;if(2>nbPts)return 0;for(var pt,dist=0,prevPt=pts[0],i=1;nbPts>i;i++)dist+=prevPt.distanceTo(pt=pts[i]),prevPt=pt;return dist},getPixelLength:function(pl,map){var ll=pl instanceof L.Polyline?pl.getLatLngs():pl,nbPts=ll.length;if(2>nbPts)return 0;for(var pt,dist=0,prevPt=map.project(ll[0]),i=1;nbPts>i;i++)dist+=prevPt.distanceTo(pt=map.project(ll[i])),prevPt=pt;return dist},projectPatternOnPath:function(path,offsetRatio,repeatRatio,map){var i,l,pathAsPoints=[];for(i=0,l=path.length;l>i;i++)pathAsPoints[i]=map.project(path[i]);var pattern=this.projectPatternOnPointPath(pathAsPoints,offsetRatio,repeatRatio);for(i=0,l=pattern.length;l>i;i++)pattern[i].latLng=map.unproject(pattern[i].pt);return pattern},projectPatternOnPointPath:function(pts,offsetRatio,repeatRatio){var positions=[],repeatIntervalLength=this.getPointPathPixelLength(pts)*repeatRatio,previous=this.interpolateOnPointPath(pts,offsetRatio);if(positions.push(previous),repeatRatio>0){var remainingPath=pts;remainingPath=remainingPath.slice(previous.predecessor),remainingPath[0]=previous.pt;for(var remainingLength=this.getPointPathPixelLength(remainingPath);remainingLength>=repeatIntervalLength;)previous=this.interpolateOnPointPath(remainingPath,repeatIntervalLength/remainingLength),positions.push(previous),remainingPath=remainingPath.slice(previous.predecessor),remainingPath[0]=previous.pt,remainingLength=this.getPointPathPixelLength(remainingPath)}return positions},interpolateOnPointPath:function(pts,ratio){var nbVertices=pts.length;if(2>nbVertices)return null;if(0>=ratio)return{pt:pts[0],predecessor:0,heading:this.computeAngle(pts[0],pts[1])};if(ratio>=1)return{pt:pts[nbVertices-1],predecessor:nbVertices-1,heading:this.computeAngle(pts[nbVertices-2],pts[nbVertices-1])};if(2==nbVertices)return{pt:this.interpolateBetweenPoints(pts[0],pts[1],ratio),predecessor:0,heading:this.computeAngle(pts[0],pts[1])};for(var pathLength=this.getPointPathPixelLength(pts),a=pts[0],b=a,ratioA=0,ratioB=0,distB=0,i=1;nbVertices>i&&ratio>ratioB;i++)a=b,ratioA=ratioB,b=pts[i],distB+=a.distanceTo(b),ratioB=distB/pathLength;var segmentRatio=(ratio-ratioA)/(ratioB-ratioA);return{pt:this.interpolateBetweenPoints(a,b,segmentRatio),predecessor:i-2,heading:this.computeAngle(a,b)}},interpolateBetweenPoints:function(ptA,ptB,ratio){return ptB.x!=ptA.x?new L.Point(ptA.x*(1-ratio)+ratio*ptB.x,ptA.y*(1-ratio)+ratio*ptB.y):new L.Point(ptA.x,ptA.y+(ptB.y-ptA.y)*ratio)}},L.RotatedMarker=L.Marker.extend({options:{angle:0},_setPos:function(pos){if(L.Marker.prototype._setPos.call(this,pos),L.DomUtil.TRANSFORM)this._icon.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(L.Browser.ie){var rad=this.options.angle*(Math.PI/180),costheta=Math.cos(rad),sintheta=Math.sin(rad);this._icon.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+costheta+", M12="+-sintheta+", M21="+sintheta+", M22="+costheta+")"}}}),L.rotatedMarker=function(pos,options){return new L.RotatedMarker(pos,options)},L.Symbol=L.Symbol||{},L.Symbol.Dash=L.Class.extend({isZoomDependant:!0,options:{pixelSize:10,pathOptions:{}},initialize:function(options){L.Util.setOptions(this,options),this.options.pathOptions.clickable=!1},buildSymbol:function(dirPoint,latLngs,map){var opts=this.options,d2r=Math.PI/180;if(opts.pixelSize<=1)return new L.Polyline([dirPoint.latLng,dirPoint.latLng],opts.pathOptions);var midPoint=map.project(dirPoint.latLng),angle=-(dirPoint.heading-90)*d2r,a=new L.Point(midPoint.x+opts.pixelSize*Math.cos(angle+Math.PI)/2,midPoint.y+opts.pixelSize*Math.sin(angle)/2),b=midPoint.add(midPoint.subtract(a));return new L.Polyline([map.unproject(a),map.unproject(b)],opts.pathOptions)}}),L.Symbol.dash=function(options){return new L.Symbol.Dash(options)},L.Symbol.ArrowHead=L.Class.extend({isZoomDependant:!0,options:{polygon:!0,pixelSize:10,headAngle:60,pathOptions:{stroke:!1,weight:2}},initialize:function(options){L.Util.setOptions(this,options),this.options.pathOptions.clickable=!1},buildSymbol:function(dirPoint,latLngs,map){var path,opts=this.options;return path=opts.polygon?new L.Polygon(this._buildArrowPath(dirPoint,map),opts.pathOptions):new L.Polyline(this._buildArrowPath(dirPoint,map),opts.pathOptions)},_buildArrowPath:function(dirPoint,map){var d2r=Math.PI/180,tipPoint=map.project(dirPoint.latLng),direction=-(dirPoint.heading-90)*d2r,radianArrowAngle=this.options.headAngle/2*d2r,headAngle1=direction+radianArrowAngle,headAngle2=direction-radianArrowAngle,arrowHead1=new L.Point(tipPoint.x-this.options.pixelSize*Math.cos(headAngle1),tipPoint.y+this.options.pixelSize*Math.sin(headAngle1)),arrowHead2=new L.Point(tipPoint.x-this.options.pixelSize*Math.cos(headAngle2),tipPoint.y+this.options.pixelSize*Math.sin(headAngle2));return[map.unproject(arrowHead1),dirPoint.latLng,map.unproject(arrowHead2)]}}),L.Symbol.arrowHead=function(options){return new L.Symbol.ArrowHead(options)},L.Symbol.Marker=L.Class.extend({isZoomDependant:!1,options:{markerOptions:{},rotate:!1},initialize:function(options){L.Util.setOptions(this,options),this.options.markerOptions.clickable=!1,this.options.markerOptions.draggable=!1,this.isZoomDependant=L.Browser.ie&&this.options.rotate},buildSymbol:function(directionPoint){return this.options.rotate?(this.options.markerOptions.angle=directionPoint.heading,new L.RotatedMarker(directionPoint.latLng,this.options.markerOptions)):new L.Marker(directionPoint.latLng,this.options.markerOptions)}}),L.Symbol.marker=function(options){return new L.Symbol.Marker(options)},L.PolylineDecorator=L.LayerGroup.extend({options:{patterns:[]},initialize:function(paths,options){L.LayerGroup.prototype.initialize.call(this),L.Util.setOptions(this,options),this._map=null,this._initPaths(paths),this._initPatterns()},_initPaths:function(p){this._paths=[];if(p instanceof L.Polyline)this._initPath(p.getLatLngs(),p instanceof L.Polygon);else if(L.Util.isArray(p)&&p.length>0)if(p[0]instanceof L.Polyline)for(var i=0;i<p.length;i++)this._initPath(p[i].getLatLngs(),p[i]instanceof L.Polygon);else this._initPath(p)},_isCoordArray:function(ll){return L.Util.isArray(ll)&&ll.length>0&&(ll[0]instanceof L.LatLng||L.Util.isArray(ll[0])&&2==ll[0].length&&"number"==typeof ll[0][0])},_initPath:function(path,isPolygon){var latLngs;latLngs=this._isCoordArray(path)?[path]:path;for(var i=0;i<latLngs.length;i++)isPolygon&&latLngs[i].push(latLngs[i][0]),this._paths.push(latLngs[i])},_initPatterns:function(){this._isZoomDependant=!1,this._patterns=[];for(var pattern,i=0;i<this.options.patterns.length;i++)pattern=this._parsePatternDef(this.options.patterns[i]),this._patterns.push(pattern),this._isZoomDependant=this._isZoomDependant||pattern.isOffsetInPixels||pattern.isRepeatInPixels||pattern.symbolFactory.isZoomDependant},setPatterns:function(patterns){this.options.patterns=patterns,this._initPatterns(),this._softRedraw()},setPaths:function(paths){this._initPaths(paths),this.redraw()},_parsePatternDef:function(patternDef){var pattern={cache:[],symbolFactory:patternDef.symbol,isOffsetInPixels:!1,isRepeatInPixels:!1};return"string"==typeof patternDef.offset&&-1!=patternDef.offset.indexOf("%")?pattern.offset=parseFloat(patternDef.offset)/100:(pattern.offset=parseFloat(patternDef.offset),pattern.isOffsetInPixels=pattern.offset>0),"string"==typeof patternDef.repeat&&-1!=patternDef.repeat.indexOf("%")?pattern.repeat=parseFloat(patternDef.repeat)/100:(pattern.repeat=parseFloat(patternDef.repeat),pattern.isRepeatInPixels=pattern.repeat>0),pattern},onAdd:function(map){this._map=map,this._draw(),this._isZoomDependant&&this._map.on("zoomend",this._softRedraw,this)},onRemove:function(map){this._map.off("zoomend",this._softRedraw,this),this._map=null,L.LayerGroup.prototype.onRemove.call(this,map)},_buildSymbols:function(latLngs,symbolFactory,directionPoints){for(var symbols=[],i=0,l=directionPoints.length;l>i;i++)symbols.push(symbolFactory.buildSymbol(directionPoints[i],latLngs,this._map,i,l));return symbols},_getCache:function(pattern,zoom,pathIndex){var zoomCache=pattern.cache[zoom];return"undefined"==typeof zoomCache?(pattern.cache[zoom]=[],null):zoomCache[pathIndex]},_getDirectionPoints:function(pathIndex,pattern){var zoom=this._map.getZoom(),dirPoints=this._getCache(pattern,zoom,pathIndex);if(dirPoints)return dirPoints;var offset,repeat,pathPixelLength=null,latLngs=this._paths[pathIndex];return pattern.isOffsetInPixels?(pathPixelLength=L.LineUtil.PolylineDecorator.getPixelLength(latLngs,this._map),offset=pattern.offset/pathPixelLength):offset=pattern.offset,pattern.isRepeatInPixels?(pathPixelLength=null!==pathPixelLength?pathPixelLength:L.LineUtil.PolylineDecorator.getPixelLength(latLngs,this._map),repeat=pattern.repeat/pathPixelLength):repeat=pattern.repeat,dirPoints=L.LineUtil.PolylineDecorator.projectPatternOnPath(latLngs,offset,repeat,this._map),pattern.cache[zoom][pathIndex]=dirPoints,dirPoints},redraw:function(){this._redraw(!0)},_softRedraw:function(){this._redraw(!1)},_redraw:function(clearCache){if(null!==this._map){if(this.clearLayers(),clearCache)for(var i=0;i<this._patterns.length;i++)this._patterns[i].cache=[];this._draw()}},_drawPattern:function(pattern){for(var directionPoints,symbols,i=0;i<this._paths.length;i++){directionPoints=this._getDirectionPoints(i,pattern),symbols=this._buildSymbols(this._paths[i],pattern.symbolFactory,directionPoints);for(var j=0;j<symbols.length;j++)this.addLayer(symbols[j])}},_draw:function(){for(var i=0;i<this._patterns.length;i++)this._drawPattern(this._patterns[i])}}),L.polylineDecorator=function(paths,options){return new L.PolylineDecorator(paths,options)},function(){function toParam(object,prefix){var value,key,stack=[];for(key in object)value=object[key],key=prefix?prefix+"["+key+"]":key,value=null===value?encodeURIComponent(key)+"=":"object"!=typeof value?encodeURIComponent(key)+"="+encodeURIComponent(value):toParam(value,key),stack.push(value);return stack.join("&")}angular.extend(angular,{toParam:toParam})}();var timerModule=angular.module("timer",[]).directive("timer",["$compile",function($compile){return{restrict:"EA",replace:!1,scope:{interval:"=interval",startTimeAttr:"=startTime",endTimeAttr:"=endTime",countdownattr:"=countdown",finishCallback:"&finishCallback",autoStart:"&autoStart",maxTimeUnit:"="},controller:["$scope","$element","$attrs","$timeout",function($scope,$element,$attrs,$timeout){function resetTimeout(){$scope.timeoutId&&clearTimeout($scope.timeoutId)}function calculateTimeUnits(){void 0!==$attrs.startTime&&($scope.millis=new Date-new Date($scope.startTimeAttr)),$scope.maxTimeUnit&&"day"!==$scope.maxTimeUnit?"second"===$scope.maxTimeUnit?($scope.seconds=Math.floor($scope.millis/1e3),$scope.minutes=0,$scope.hours=0,$scope.days=0,$scope.months=0,$scope.years=0):"minute"===$scope.maxTimeUnit?($scope.seconds=Math.floor($scope.millis/1e3%60),$scope.minutes=Math.floor($scope.millis/6e4),$scope.hours=0,$scope.days=0,$scope.months=0,$scope.years=0):"hour"===$scope.maxTimeUnit?($scope.seconds=Math.floor($scope.millis/1e3%60),$scope.minutes=Math.floor($scope.millis/6e4%60),$scope.hours=Math.floor($scope.millis/36e5),$scope.days=0,$scope.months=0,$scope.years=0):"month"===$scope.maxTimeUnit?($scope.seconds=Math.floor($scope.millis/1e3%60),$scope.minutes=Math.floor($scope.millis/6e4%60),$scope.hours=Math.floor($scope.millis/36e5%24),$scope.days=Math.floor($scope.millis/36e5/24%30),$scope.months=Math.floor($scope.millis/36e5/24/30),$scope.years=0):"year"===$scope.maxTimeUnit&&($scope.seconds=Math.floor($scope.millis/1e3%60),$scope.minutes=Math.floor($scope.millis/6e4%60),$scope.hours=Math.floor($scope.millis/36e5%24),$scope.days=Math.floor($scope.millis/36e5/24%30),$scope.months=Math.floor($scope.millis/36e5/24/30%12),$scope.years=Math.floor($scope.millis/36e5/24/365)):($scope.seconds=Math.floor($scope.millis/1e3%60),$scope.minutes=Math.floor($scope.millis/6e4%60),$scope.hours=Math.floor($scope.millis/36e5%24),$scope.days=Math.floor($scope.millis/36e5/24),$scope.months=0,$scope.years=0),$scope.secondsS=1===$scope.seconds?"":"s",$scope.minutesS=1===$scope.minutes?"":"s",$scope.hoursS=1===$scope.hours?"":"s",$scope.daysS=1===$scope.days?"":"s",$scope.monthsS=1===$scope.months?"":"s",$scope.yearsS=1===$scope.years?"":"s",$scope.secondUnit=function(singleSecond,pluralSecond){return 1===$scope.seconds?singleSecond?singleSecond:"second":pluralSecond?pluralSecond:"seconds"},$scope.minuteUnit=function(singleMinute,pluralMinute){return 1===$scope.minutes?singleMinute?singleMinute:"minute":pluralMinute?pluralMinute:"minutes"},$scope.hourUnit=function(singleHour,pluralHour){return 1===$scope.hours?singleHour?singleHour:"hour":pluralHour?pluralHour:"hours"},$scope.dayUnit=function(singleDay,pluralDay){return 1===$scope.days?singleDay?singleDay:"day":pluralDay?pluralDay:"days"},$scope.monthUnit=function(singleMonth,pluralMonth){return 1===$scope.months?singleMonth?singleMonth:"month":pluralMonth?pluralMonth:"months"},$scope.yearUnit=function(singleYear,pluralYear){return 1===$scope.years?singleYear?singleYear:"year":pluralYear?pluralYear:"years"},$scope.sseconds=$scope.seconds<10?"0"+$scope.seconds:$scope.seconds,$scope.mminutes=$scope.minutes<10?"0"+$scope.minutes:$scope.minutes,$scope.hhours=$scope.hours<10?"0"+$scope.hours:$scope.hours,$scope.ddays=$scope.days<10?"0"+$scope.days:$scope.days,$scope.mmonths=$scope.months<10?"0"+$scope.months:$scope.months,$scope.yyears=$scope.years<10?"0"+$scope.years:$scope.years}"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),$scope.autoStart=$attrs.autoStart||$attrs.autostart,$element.append(0===$element.html().trim().length?$compile("<span>{{millis}}</span>")($scope):$compile($element.contents())($scope)),$scope.startTime=null,$scope.endTime=null,$scope.timeoutId=null,$scope.countdown=$scope.countdownattr&&parseInt($scope.countdownattr,10)>=0?parseInt($scope.countdownattr,10):void 0,$scope.isRunning=!1,$scope.$on("timer-start",function(){$scope.start()}),$scope.$on("timer-resume",function(){$scope.resume()}),$scope.$on("timer-stop",function(){$scope.stop()}),$scope.$on("timer-clear",function(){$scope.clear()}),$scope.$on("timer-reset",function(){$scope.reset()}),$scope.$on("timer-set-countdown",function(e,countdown){$scope.countdown=countdown}),$scope.start=$element[0].start=function(){$scope.startTime=$scope.startTimeAttr?new Date($scope.startTimeAttr):new Date,$scope.endTime=$scope.endTimeAttr?new Date($scope.endTimeAttr):null,$scope.countdown||($scope.countdown=$scope.countdownattr&&parseInt($scope.countdownattr,10)>0?parseInt($scope.countdownattr,10):void 0),resetTimeout(),tick(),$scope.isRunning=!0},$scope.resume=$element[0].resume=function(){resetTimeout(),$scope.countdownattr&&($scope.countdown+=1),$scope.startTime=new Date-($scope.stoppedTime-$scope.startTime),tick(),$scope.isRunning=!0},$scope.stop=$scope.pause=$element[0].stop=$element[0].pause=function(){var timeoutId=$scope.timeoutId;$scope.clear(),$scope.$emit("timer-stopped",{timeoutId:timeoutId,millis:$scope.millis,seconds:$scope.seconds,minutes:$scope.minutes,hours:$scope.hours,days:$scope.days})},$scope.clear=$element[0].clear=function(){$scope.stoppedTime=new Date,resetTimeout(),$scope.timeoutId=null,$scope.isRunning=!1},$scope.reset=$element[0].reset=function(){$scope.startTime=$scope.startTimeAttr?new Date($scope.startTimeAttr):new Date,$scope.endTime=$scope.endTimeAttr?new Date($scope.endTimeAttr):null,$scope.countdown=$scope.countdownattr&&parseInt($scope.countdownattr,10)>0?parseInt($scope.countdownattr,10):void 0,resetTimeout(),tick(),$scope.isRunning=!1,$scope.clear()},$element.bind("$destroy",function(){resetTimeout(),$scope.isRunning=!1}),$scope.countdownattr?($scope.millis=1e3*$scope.countdownattr,$scope.addCDSeconds=$element[0].addCDSeconds=function(extraSeconds){$scope.countdown+=extraSeconds,$scope.$digest(),$scope.isRunning||$scope.start()},$scope.$on("timer-add-cd-seconds",function(e,extraSeconds){$timeout(function(){$scope.addCDSeconds(extraSeconds)})}),$scope.$on("timer-set-countdown-seconds",function(e,countdownSeconds){$scope.isRunning||$scope.clear(),$scope.countdown=countdownSeconds,$scope.millis=1e3*countdownSeconds,calculateTimeUnits()})):$scope.millis=0,calculateTimeUnits();var tick=function(){$scope.millis=new Date-$scope.startTime;var adjustment=$scope.millis%1e3;return $scope.endTimeAttr&&($scope.millis=$scope.endTime-new Date,adjustment=$scope.interval-$scope.millis%1e3),$scope.countdownattr&&($scope.millis=1e3*$scope.countdown),$scope.millis<0?($scope.stop(),$scope.millis=0,calculateTimeUnits(),void($scope.finishCallback&&$scope.$eval($scope.finishCallback))):(calculateTimeUnits(),$scope.timeoutId=setTimeout(function(){tick(),$scope.$digest()},$scope.interval-adjustment),$scope.$emit("timer-tick",{timeoutId:$scope.timeoutId,millis:$scope.millis}),void($scope.countdown>0?$scope.countdown--:$scope.countdown<=0&&($scope.stop(),$scope.finishCallback&&$scope.$eval($scope.finishCallback))))};(void 0===$scope.autoStart||$scope.autoStart===!0)&&$scope.start()}]}}]);"undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports=timerModule);var calendarModule=angular.module("calendarModule",[]).constant("constantCalendar",{days:["П","B","C","Ч","П","С","B"],month:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]});calendarModule.directive("calendar",["$compile","$templateCache","constantCalendar","$timeout",function(a,b,c,d){function e(a,b,c){function d(a){var b="";return e==a.getTime()&&(b+="current"),f<=a.getTime()&&a.getTime()<=g&&(b+=" select"),b}for(var e=new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()).getTime(),f=b.getTime(),g=c.getTime(),h=[],i=0;50>i;i++){var j=new Date(a.getFullYear(),a.getMonth(),i);j.getMonth()==a.getMonth()&&h.push({date:j,value:j.getTime(),dayWeek:j.getDay(),"class":d(j)})}for(var k=0==h[0].dayWeek?6:h[0].dayWeek-1,l=0==h[h.length-1].dayWeek?0:7-h[h.length-1].dayWeek,i=0;k>i;i++)h.unshift(null);for(var i=0;l>i;i++)h.push(null);for(var m=parseFloat((h.length/7).toFixed(0)),n=[],o=0,i=0;m>i;i++){n[i]=[];for(var j=0;7>j;j++)n[i].push(h[o]),o++}return n}return{restrict:"EA",replace:!0,templateUrl:"module/partials/calendar-label.html",scope:{before:"=before",after:"=after",link:"@link"},controller:["$scope","$element","$attrs","$timeout","$templateCache",function(a,b){function d(b){i=new Date(b.getFullYear(),b.getMonth()-1,b.getDate()),j=new Date(b.getFullYear(),b.getMonth()+1,b.getDate()),a.arrMonth=e(b,a.after,a.before),a.arrMonth.value=b.getTime(),a.arrMonthBefore=e(i,a.after,a.before),a.arrMonthBefore.value=i.getTime(),a.arrMonthAfter=e(j,a.after,a.before),a.arrMonthAfter.value=j.getTime()}function f(c){var d=!1;angular.forEach(a.calendarElement.find("*"),function(a){return angular.equals(angular.element(a),angular.element(c.target))?void(d=!0):void 0}),d||angular.forEach(b.find("*"),function(a){return angular.equals(angular.element(a),angular.element(c.target))?void(d=!0):void 0}),d||(a.show=!1,a.$apply())}function g(){window.document.removeEventListener("click",f)}var h="true"==a.link?!0:!1;a.show=!1,a.constantCalendar=c,a.beforeLabelValue=a.before,a.afterLabelValue=a.after;var i,j,k=new Date(a.after.getTime()+(a.before.getTime()-a.after.getTime())/2);a.includeMonths="module/partials/container-months.html",d(k),a.stepBack=function(){var a=new Date(k.getFullYear(),k.getMonth()-1,k.getDate());k=a,d(a)},a.stepForward=function(){var a=new Date(k.getFullYear(),k.getMonth()+1,k.getDate());k=a,d(a)},a.selectEvent=function(b){a.before.getTime()<b.value?a.before=new Date(b.value):b.value<a.after.getTime()?a.after=new Date(b.value):(a.after=new Date(b.value),a.before=new Date(b.value)),h&&(a.beforeLabelValue=a.before,a.afterLabelValue=a.after)},a.apply=function(){a.click()},a.$watch("before",function(){d(k)}),a.$watch("after",function(){d(k)}),a.$watch("show",function(a){a?window.document.addEventListener("click",f):window.document.removeEventListener("click",f)}),a.$on("$destroy",function(){console.log("destroy"),g()})}],link:function(c){function e(){var e=a(b.get("module/partials/calendar-view.html"));f=e(c),f.css("display","none");var g=angular.element(document.body);g.append(f),c.calendarElement=f,d(function(){c.show=!0,f.css("display","inherit")},1)}var f=null;c.show=!1,c.click=function(){return f?(c.show=!c.show,void console.log(c.show)):void e()}}}}]),calendarModule.directive("daysweek",["$compile","constantCalendar",function(a,b){return{restrict:"E",replace:!0,scope:{},templateUrl:"module/partials/calendar-days.html",controller:["$scope",function(a){a.constantCalendar=b}]}}]),angular.module("calendarModule").run(["$templateCache",function(a){a.put("module/partials/calendar-days.html",'<div class="row days"><div class="col-day text-right" ng-repeat="days in constantCalendar.days track by $index"><span ng-switch="$index"><span ng-switch-when="6" class="red">{{days}}</span> <span ng-switch-when="5" class="red">{{days}}</span> <span ng-switch-default>{{days}}</span></span></div></div>'),a.put("module/partials/calendar-label.html",'<div class="calendar-label"><div class="calendar-label-ico" ng-click="click()"><div class="ico-calendar">&nbsp;</div></div><div class="calendar-label-btn" ng-class="show && \'open\'" ng-click="click()">{{after | date:\'dd MMM\'}} - {{beforeLabelValue | date:\'dd MMM\'}} {{before | date:\'yyyy\'}}</div></div>'),a.put("module/partials/calendar-view.html",'<div ng-show="show" class="calendar-view"><div class="container-months"><div ng-include="includeMonths"></div></div><div class="info-block"><div class="info-label"><div class=""><div class="info-label-value">{{ after | date:\'yyyy.MM.dd\' }}</div></div><div><div class="info-label-value">{{ before | date:\'yyyy.MM.dd\' }}</div></div><div><div class="button" ng-click="apply()">Close</div></div></div></div></div>'),a.put("module/partials/container-months.html",'<table><tr><td><!--текущий--><div class="block-month"><daysweek></daysweek><div class="border-line"><div class="btn-back" ng-click="stepBack()">&#8249;</div><div class="btn-forward" ng-click="stepForward()">&#8250;</div></div><div class="row name-month">{{arrMonth.value | date:\'MMMM yyyy\'}}</div><div class="numeric"><div class="row" ng-repeat="week in arrMonth track by $index"><div class="col-day text-right {{day.class}}" ng-repeat="day in arrMonth[$index] track by $index" ng-click="selectEvent(day)"><span ng-switch="$index"><span ng-switch-when="6" class="red">{{day.value | date:\'d\'}}</span> <span ng-switch-when="5" class="red">{{day.value | date:\'d\'}}</span> <span ng-switch-default>{{day.value | date:\'d\'}}</span></span></div></div></div></div></td></tr></table>')}]),angular.module("ngDraggable",[]).service("ngDraggable",["$window",function($window){var isDef=function(val){return"undefined"!=typeof val};this.getEventProp=function(evt,prop,skipOriginal){return isDef(evt.touches)&&evt.touches[0]?evt.touches[0][prop]:isDef(evt[prop])?evt[prop]:evt.originalEvent&&!skipOriginal?this.getEventProp(evt.originalEvent,prop,!0):void 0},this.getPrivOffset=function(docElem){var box={top:0,left:0};return isDef(docElem[0].getBoundingClientRect)&&(box=docElem[0].getBoundingClientRect()),{top:box.top+$window.pageYOffset-docElem[0].clientTop,left:box.left+$window.pageXOffset-docElem[0].clientLeft}}}]).directive("ngDrag",["$rootScope","$parse","$document","$window","ngDraggable",function($rootScope,$parse,$document,$window,ngDraggable){return{restrict:"A",link:function(scope,element,attrs){scope.value=attrs.ngDrag,scope.offsetLeft=attrs.offsetLeft;var _dragReset="false"==attrs.dragReset?!1:!0,_axisX=/x/.test(attrs.dragAxis)?!0:!1,_axisY=/y/.test(attrs.dragAxis)?!0:!1;attrs.dragAxis||(_axisX=!0,_axisY=!0);var offset,_mx,_my,_tx,_ty,_mrx,_mry,_centerAnchor=!1,_hasTouch="ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch,_pressEvents="touchstart mousedown",_moveEvents="touchmove mousemove",_releaseEvents="touchend mouseup",_myid=scope.$id,_data=null,_dragOffset=null,_dragEnabled=!1,_pressTimer=null,onDragSuccessCallback=$parse(attrs.ngDragSuccess)||null,initialize=function(){element.attr("draggable","false"),toggleListeners(!0)},toggleListeners=function(enable){enable&&(scope.$on("$destroy",onDestroy),scope.$watch(attrs.ngDrag,onEnableChange),scope.$watch(attrs.ngCenterAnchor,onCenterAnchor),scope.$watch(attrs.ngDragData,onDragDataChange),element.on(_pressEvents,onpress),_hasTouch||"img"!=element[0].nodeName.toLowerCase()||element.on("mousedown",function(){return!1}))},onDestroy=function(){toggleListeners(!1)},onDragDataChange=function(newVal){_data=newVal},onEnableChange=function(newVal){_dragEnabled=newVal},onCenterAnchor=function(newVal){angular.isDefined(newVal)&&(_centerAnchor=newVal||"true")},isClickableElement=function(evt){return angular.isDefined(angular.element(evt.target).attr("ng-click"))||angular.isDefined(angular.element(evt.target).attr("ng-dblclick"))||angular.isDefined(angular.element(evt.target).attr("ng-cancel-drag"))},onpress=function(evt){_dragEnabled&&(isClickableElement(evt)||(_hasTouch?(cancelPress(),_pressTimer=setTimeout(function(){cancelPress(),onlongpress(evt)},100),$document.on(_moveEvents,cancelPress),$document.on(_releaseEvents,cancelPress)):onlongpress(evt)))},cancelPress=function(){clearTimeout(_pressTimer),$document.off(_moveEvents,cancelPress),$document.off(_releaseEvents,cancelPress)},onlongpress=function(evt){_dragEnabled&&(evt.preventDefault(),element.addClass("dragging"),offset=ngDraggable.getPrivOffset(element),_dragOffset=offset,element.centerX=element[0].offsetWidth/2,element.centerY=element[0].offsetHeight/2,_mx=ngDraggable.getEventProp(evt,"pageX"),_my=ngDraggable.getEventProp(evt,"pageY"),_mrx=_mx-offset.left,_mry=_my-offset.top,_centerAnchor?(_tx=_mx-element.centerX-$window.pageXOffset,_ty=_my-element.centerY-$window.pageYOffset):(_tx=_mx-_mrx-$window.pageXOffset,_ty=_my-_mry-$window.pageYOffset),$document.on(_moveEvents,onmove),$document.on(_releaseEvents,onrelease),$rootScope.$broadcast("draggable:start",{x:_mx,y:_my,tx:_tx,ty:_ty,event:evt,element:element,data:_data}))},onmove=function(evt){_dragEnabled&&(evt.preventDefault(),_mx=ngDraggable.getEventProp(evt,"pageX"),_my=ngDraggable.getEventProp(evt,"pageY"),_centerAnchor?(_tx=_mx-element.centerX-_dragOffset.left,_ty=_my-element.centerY-_dragOffset.top):(_tx=_mx-_mrx-_dragOffset.left,_ty=_my-_mry-_dragOffset.top),moveElement(_tx,_ty),$rootScope.$broadcast("draggable:move",{x:_mx,y:_my,tx:_tx,ty:_ty,event:evt,element:element,data:_data,uid:_myid}))},onrelease=function(evt){_dragEnabled&&(evt.preventDefault(),$rootScope.$broadcast("draggable:end",{x:_mx,y:_my,tx:_tx,ty:_ty,event:evt,element:element,data:_data,callback:onDragComplete,uid:_myid}),element.removeClass("dragging"),reset(),$document.off(_moveEvents,onmove),$document.off(_releaseEvents,onrelease))},onDragComplete=function(evt){onDragSuccessCallback&&scope.$apply(function(){onDragSuccessCallback(scope,{$data:_data,$event:evt})})},reset=function(){_dragReset?element.css({transform:"","z-index":""}):(attrs.$set("offset-left",(parseFloat(element.css("left"))||0)+_tx),element.css("left",(parseFloat(element.css("left"))||0)+_tx+"px"),element.css({transform:"","z-index":""}))},moveElement=function(x,y){_axisX&&!_axisY?y=0:!_axisX&&_axisY&&(x=0),element.css({transform:"matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+x+", "+y+", 0, 1)","z-index":99999})};initialize()}}}]).directive("ngDrop",["$parse","$timeout","$window","ngDraggable",function($parse,$timeout,$window,ngDraggable){return{restrict:"A",link:function(scope,element,attrs){scope.value=attrs.ngDrop;var _myid=scope.$id,_dropEnabled=!1,onDropCallback=$parse(attrs.ngDropSuccess),initialize=function(){toggleListeners(!0)},toggleListeners=function(enable){enable&&(attrs.$observe("ngDrop",onEnableChange),scope.$on("$destroy",onDestroy),scope.$on("draggable:start",onDragStart),scope.$on("draggable:move",onDragMove),scope.$on("draggable:end",onDragEnd))},onDestroy=function(){toggleListeners(!1)},onEnableChange=function(newVal){_dropEnabled=scope.$eval(newVal)},onDragStart=function(evt,obj){_dropEnabled&&isTouching(obj.x,obj.y,obj.element)},onDragMove=function(evt,obj){_dropEnabled&&isTouching(obj.x,obj.y,obj.element)},onDragEnd=function(evt,obj){_dropEnabled&&_myid!==obj.uid&&(isTouching(obj.x,obj.y,obj.element)&&(obj.callback&&obj.callback(obj),$timeout(function(){onDropCallback(scope,{$data:obj.data,$event:obj})})),updateDragStyles(!1,obj.element))},isTouching=function(mouseX,mouseY,dragElement){var touching=hitTest(mouseX,mouseY);return updateDragStyles(touching,dragElement),touching},updateDragStyles=function(touching,dragElement){touching?(element.addClass("drag-enter"),dragElement.addClass("drag-over")):(element.removeClass("drag-enter"),dragElement.removeClass("drag-over"))},hitTest=function(x,y){var bounds=ngDraggable.getPrivOffset(element);return bounds.right=bounds.left+element[0].offsetWidth,bounds.bottom=bounds.top+element[0].offsetHeight,x>=bounds.left&&x<=bounds.right&&y<=bounds.bottom&&y>=bounds.top};initialize()}}}]).directive("ngDragClone",["$parse","$timeout","ngDraggable",function($parse,$timeout,ngDraggable){return{restrict:"A",link:function(scope,element){var img,_allowClone=!0,_dragOffset=null;scope.clonedData={};var initialize=function(){img=element.find("img"),element.attr("draggable","false"),img.attr("draggable","false"),reset(),toggleListeners(!0)},toggleListeners=function(enable){enable&&(scope.$on("draggable:start",onDragStart),scope.$on("draggable:move",onDragMove),scope.$on("draggable:end",onDragEnd),preventContextMenu())},preventContextMenu=function(){img.off("mousedown touchstart touchmove touchend touchcancel",absorbEvent_),img.on("mousedown touchstart touchmove touchend touchcancel",absorbEvent_)},onDragStart=function(evt,obj){_allowClone=!0,angular.isDefined(obj.data.allowClone)&&(_allowClone=obj.data.allowClone),_allowClone&&(scope.$apply(function(){scope.clonedData=obj.data}),element.css("width",obj.element[0].offsetWidth),element.css("height",obj.element[0].offsetHeight),moveElement(obj.tx,obj.ty)),_dragOffset=ngDraggable.getPrivOffset(element)},onDragMove=function(evt,obj){_allowClone&&(_tx=obj.tx+_dragOffset.left,_ty=obj.ty+_dragOffset.top,moveElement(_tx,_ty))},onDragEnd=function(){_allowClone&&reset()},reset=function(){element.css({left:0,top:0,position:"fixed","z-index":-1,visibility:"hidden"})},moveElement=function(x,y){element.css({transform:"matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+x+", "+y+", 0, 1)","z-index":99999,visibility:"visible"})},absorbEvent_=function(event){var e=event.originalEvent;return e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0,e.returnValue=!1,!1};initialize()}}}]).directive("ngPreventDrag",["$parse","$timeout",function(){return{restrict:"A",link:function(scope,element){var initialize=function(){element.attr("draggable","false"),toggleListeners(!0)},toggleListeners=function(enable){enable&&element.on("mousedown touchstart touchmove touchend touchcancel",absorbEvent_)},absorbEvent_=function(event){var e=event.originalEvent;return e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0,e.returnValue=!1,!1};initialize()}}}]).directive("ngCancelDrag",[function(){return{restrict:"A",link:function(scope,element){element.find("*").attr("ng-cancel-drag","ng-cancel-drag")}}}]),function($){var daysInWeek=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDaysInWeek=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],shortMonthsInYear=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],longMonthsInYear=["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonthsToNumber={Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12"},YYYYMMDD_MATCHER=/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.?\d{0,3}[Z\-+]?(\d{2}:?\d{2})?/;
$.format=function(){function numberToLongDay(value){return daysInWeek[parseInt(value,10)]||value}function numberToShortDay(value){return shortDaysInWeek[parseInt(value,10)]||value}function numberToShortMonth(value){var monthArrayIndex=parseInt(value,10)-1;return shortMonthsInYear[monthArrayIndex]||value}function numberToLongMonth(value){var monthArrayIndex=parseInt(value,10)-1;return longMonthsInYear[monthArrayIndex]||value}function shortMonthToNumber(value){return shortMonthsToNumber[value]||value}function parseTime(value){var hour,minute,second,delimited,timeArray,time=value,millis="";return-1!==time.indexOf(".")&&(delimited=time.split("."),time=delimited[0],millis=delimited[1]),timeArray=time.split(":"),3===timeArray.length?(hour=timeArray[0],minute=timeArray[1],second=timeArray[2].replace(/\s.+/,"").replace(/[a-z]/gi,""),time=time.replace(/\s.+/,"").replace(/[a-z]/gi,""),{time:time,hour:hour,minute:minute,second:second,millis:millis}):{time:"",hour:"",minute:"",second:"",millis:""}}function padding(value,length){for(var paddingCount=length-String(value).length,i=0;paddingCount>i;i++)value="0"+value;return value}return{parseDate:function(value){var parsedDate={date:null,year:null,month:null,dayOfMonth:null,dayOfWeek:null,time:null};if("number"==typeof value)return this.parseDate(new Date(value));if("function"==typeof value.getFullYear)parsedDate.year=String(value.getFullYear()),parsedDate.month=String(value.getMonth()+1),parsedDate.dayOfMonth=String(value.getDate()),parsedDate.time=parseTime(value.toTimeString());else if(-1!=value.search(YYYYMMDD_MATCHER))values=value.split(/[T\+-]/),parsedDate.year=values[0],parsedDate.month=values[1],parsedDate.dayOfMonth=values[2],parsedDate.time=parseTime(values[3].split(".")[0]);else switch(values=value.split(" "),6===values.length&&isNaN(values[5])&&(values[values.length]="()"),values.length){case 6:parsedDate.year=values[5],parsedDate.month=shortMonthToNumber(values[1]),parsedDate.dayOfMonth=values[2],parsedDate.time=parseTime(values[3]);break;case 2:subValues=values[0].split("-"),parsedDate.year=subValues[0],parsedDate.month=subValues[1],parsedDate.dayOfMonth=subValues[2],parsedDate.time=parseTime(values[1]);break;case 7:case 9:case 10:parsedDate.year=values[3],parsedDate.month=shortMonthToNumber(values[1]),parsedDate.dayOfMonth=values[2],parsedDate.time=parseTime(values[4]);break;case 1:subValues=values[0].split(""),parsedDate.year=subValues[0]+subValues[1]+subValues[2]+subValues[3],parsedDate.month=subValues[5]+subValues[6],parsedDate.dayOfMonth=subValues[8]+subValues[9],parsedDate.time=parseTime(subValues[13]+subValues[14]+subValues[15]+subValues[16]+subValues[17]+subValues[18]+subValues[19]+subValues[20]);break;default:return null}return parsedDate.date=new Date(parsedDate.year,parsedDate.month-1,parsedDate.dayOfMonth),parsedDate.dayOfWeek=String(parsedDate.date.getDay()),parsedDate},date:function(value,format){try{var parsedDate=this.parseDate(value);if(null===parsedDate)return value;for(var year=(parsedDate.date,parsedDate.year),month=parsedDate.month,dayOfMonth=parsedDate.dayOfMonth,dayOfWeek=parsedDate.dayOfWeek,time=parsedDate.time,pattern="",retValue="",unparsedRest="",inQuote=!1,i=0;i<format.length;i++){var currentPattern=format.charAt(i),nextRight=format.charAt(i+1);if(inQuote)"'"==currentPattern?(retValue+=""===pattern?"'":pattern,pattern="",inQuote=!1):pattern+=currentPattern;else switch(pattern+=currentPattern,unparsedRest="",pattern){case"ddd":retValue+=numberToLongDay(dayOfWeek),pattern="";break;case"dd":if("d"===nextRight)break;retValue+=padding(dayOfMonth,2),pattern="";break;case"d":if("d"===nextRight)break;retValue+=parseInt(dayOfMonth,10),pattern="";break;case"D":dayOfMonth=1==dayOfMonth||21==dayOfMonth||31==dayOfMonth?parseInt(dayOfMonth,10)+"st":2==dayOfMonth||22==dayOfMonth?parseInt(dayOfMonth,10)+"nd":3==dayOfMonth||23==dayOfMonth?parseInt(dayOfMonth,10)+"rd":parseInt(dayOfMonth,10)+"th",retValue+=dayOfMonth,pattern="";break;case"MMMM":retValue+=numberToLongMonth(month),pattern="";break;case"MMM":if("M"===nextRight)break;retValue+=numberToShortMonth(month),pattern="";break;case"MM":if("M"===nextRight)break;retValue+=padding(month,2),pattern="";break;case"M":if("M"===nextRight)break;retValue+=parseInt(month,10),pattern="";break;case"y":case"yyy":if("y"===nextRight)break;retValue+=pattern,pattern="";break;case"yy":if("y"===nextRight)break;retValue+=String(year).slice(-2),pattern="";break;case"yyyy":retValue+=year,pattern="";break;case"HH":retValue+=padding(time.hour,2),pattern="";break;case"H":if("H"===nextRight)break;retValue+=parseInt(time.hour,10),pattern="";break;case"hh":hour=0===parseInt(time.hour,10)?12:time.hour<13?time.hour:time.hour-12,retValue+=padding(hour,2),pattern="";break;case"h":if("h"===nextRight)break;hour=0===parseInt(time.hour,10)?12:time.hour<13?time.hour:time.hour-12,retValue+=parseInt(hour,10),pattern="";break;case"mm":retValue+=padding(time.minute,2),pattern="";break;case"m":if("m"===nextRight)break;retValue+=time.minute,pattern="";break;case"ss":retValue+=padding(time.second.substring(0,2),2),pattern="";break;case"s":if("s"===nextRight)break;retValue+=time.second,pattern="";break;case"S":case"SS":if("S"===nextRight)break;retValue+=pattern,pattern="";break;case"SSS":retValue+=time.millis.substring(0,3),pattern="";break;case"a":retValue+=time.hour>=12?"PM":"AM",pattern="";break;case"p":retValue+=time.hour>=12?"p.m.":"a.m.",pattern="";break;case"E":retValue+=numberToShortDay(dayOfWeek),pattern="";break;case"'":pattern="",inQuote=!0;break;default:retValue+=currentPattern,pattern=""}}return retValue+=unparsedRest}catch(e){return console&&console.log&&console.log(e),value}},prettyDate:function(time){var date,diff,day_diff;return("string"==typeof time||"number"==typeof time)&&(date=new Date(time)),"object"==typeof time&&(date=new Date(time.toString())),diff=((new Date).getTime()-date.getTime())/1e3,day_diff=Math.floor(diff/86400),isNaN(day_diff)||0>day_diff?void 0:60>diff?"just now":120>diff?"1 minute ago":3600>diff?Math.floor(diff/60)+" minutes ago":7200>diff?"1 hour ago":86400>diff?Math.floor(diff/3600)+" hours ago":1===day_diff?"Yesterday":7>day_diff?day_diff+" days ago":31>day_diff?Math.ceil(day_diff/7)+" weeks ago":day_diff>=31?"more than 5 weeks ago":void 0},toBrowserTimeZone:function(value,format){return this.date(new Date(value),format||"MM/dd/yyyy HH:mm:ss")}}}()}(angular);var app=angular.module("app",["ngAnimate","timer","calendarModule","ngDraggable"]).config(["$httpProvider",function($httpProvider){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8",$httpProvider.defaults.transformRequest=function(data){return angular.isObject(data)&&"[object File]"!==String(data)?angular.toParam(data):data},$httpProvider.interceptors.push("authHttpResponseInterceptor")}]).factory("authHttpResponseInterceptor",["$q","$location",function($q){return{response:function(response){return 401===response.status&&console.log("Response 401"),response||$q.when(response)},responseError:function(rejection){if(401===rejection.status){var path=window.location.origin+"/"+window.location.pathname.split("/")[1]+"/";console.log(path),window.location=path}return $q.reject(rejection)}}}]).constant("windowSize",{width:window.innerWidth,height:window.innerHeight}).constant("tileLayers",{ggl:new L.TileLayer("http://mt0.googleapis.com/vt/lyrs=m@207000000&hl=ru&src=api&x={x}&y={y}&z={z}&s=Galile",{maxZoom:18,minZoom:3}),osm:new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),osmVelo:new L.TileLayer("http://a.tile.thunderforest.com/cycle/{z}/{x}/{y}.png"),huma:new L.TileLayer("http://a.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png"),mapia:new L.tileLayer("http://{s}{hash}.wikimapia.org/?x={x}&y={y}&zoom={z}&r=7071412&type=&lng=1",{hash:function(data){return data.x%4+data.y%4*4},subdomains:"i",maxZoom:18,attribution:'<a href="http://wikimapia.org" target="_blank">Wikimapia.org</a>'})}).constant("timeZone",function(){for(var a=[],i=-23;24>i;i++)a.push({text:0>i?""+i:"+"+i,value:i});return a}()).service("map",function(){var map=L.map("mapMap",{dragging:!1,closePopupOnClick:!1});L.Icon.Default.imagePath="build/images",L.DivIcon=L.Icon.extend({createIcon:function(oldIcon){var div=oldIcon&&"DIV"===oldIcon.tagName?oldIcon:document.createElement("div"),options=this.options;return options.html!==!1?angular.isElement(options.html)?div.appendChild(options.html[0]):div.innerHTML=options.html:div.innerHTML="",options.bgPos&&(div.style.backgroundPosition=-options.bgPos.x+"px "+-options.bgPos.y+"px"),this._setIconStyles(div,"icon"),div}}),this.map=map,this.lat=null,this.scope={},this.name="ddd"}).factory("hashLocation",function(map){function latlng(){lat=map.map.getCenter().lat.toFixed(6),lng=map.map.getCenter().lng.toFixed(6)}function setHash(){latlng(),window.location.hash="/param?lat="+lat+"&lng="+lng}function event(){map.map.on("dragend",setHash)}var lat,lng;return{event:event}}).run(function(){window.F=parseFloat,String.prototype.f=function(){return parseFloat(this)}});angular.module("app").run(["$templateCache",function($templateCache){$templateCache.put("item/block-one-object.html",'<div ng-repeat="obj in factoryGetDevices | orderBy:\'text\'" class="block-one-object" ng-click="setCurrent(obj.imei)"><div class="row-head"><div class="row-footer-obj"><div class="row"><div class="col-5"><h3>{{obj.text}}</h3></div><div class="col-5">{{obj.phone}}</div><div class="col-2 text-right"><div state-obj elapsed-time="obj._elapsedTime" device="obj" speed="obj.speed"></div></div></div><div class="row"><timer start-time="obj._dateTime">{{days}} days, {{hours}} hours, {{minutes}} min, {{seconds}} sec.</timer></div><div class="hidden-line" style="margin-top: 5px"></div><div class="row"><div class="col-4"><div>{{ (obj._dateTime || null ) | date:\'yy.MM.dd\'}}</div><div>{{ (obj._dateTime || null ) | date:\'HH.mm.ss\'}}</div></div><div class="col-2"><div class="row">Сп</div><div class="row">{{obj.satellites}}</div></div><div class="col-2"><div class="row">Ск</div><div class="row">{{obj.speed}}</div></div><div class="col-2"><div class="row">Бат</div><div class="row">{{obj.zaryad}}</div></div></div><div class="row"></div></div></div></div>'),$templateCache.put("item/container-blocks.html",'<div class="block-item target" ng-class="item.target"><div ng-controller="objectsContrl"><div class="title"><div>Объекты<div class="button-close float-right" ng-click="show(\'target\')"></div></div></div><div ng-include="\'item/block-one-object.html\'" class="list-objects"></div></div></div><div class="block-item rout" ng-class="item.rout"><div><div class="title">Mаршруты<div class="button float-right" ng-click="show(\'rout\')">x</div></div></div></div><div class="block-item zone" ng-class="item.zone"><div><div class="title">Зоны<div class="button float-right" ng-click="show(\'zone\')">x</div></div></div></div>'),$templateCache.put("item/elapsed-post.html",'<div class="elapsed-post"><timer start-time="factoryGetDevices.timePost"><div tik>{{minutes}} min {{seconds}} sec</div></timer></div>'),$templateCache.put("item/footer.html",'<div class="table"><div class="table-cell content"><div>Map:</div><div name="lat">{{factoryGetOptions.lat}}</div><div name="lng">{{factoryGetOptions.lng}}</div><div>Mouse:</div><div>{{factoryGetOptions.mouselat}}</div><div>{{factoryGetOptions.mouselng}}</div></div></div>'),$templateCache.put("item/header.html",'<div style="position: absolute"><div class="button" ng-click="show(\'target\')">Объекты</div><div class="button" ng-click="show(\'zone\')">Зоны</div><div class="button" ng-click="serviceShowElements.showReport=!serviceShowElements.showReport">Отчет</div></div><div style="float: right"><div class="button" ng-click="settingsShow()">Настройки</div><div class="button" ng-click="exit()">Выход</div></div><div class="container-blocks" ng-include="\'item/container-blocks.html\'"></div>'),$templateCache.put("item/info-object.html",'<div class="info-object" ng-show="serviceShowElements.showInfo"><div class="row">{{factoryGetDevices.current.text || \'None\'}} {{factoryGetDevices.current.imei}}</div><div class="row"><div class="col-5">Скорость:</div><div class="col-7">{{factoryGetDevices.current.speed}}</div></div><div class="row" ng-if="factoryGetDevices.current._dateTime"><timer start-time="factoryGetDevices.current._dateTime">{{days}} days, {{hours}} hours, {{minutes}} min, {{seconds}} sec.</timer></div><div class="row" ng-if="factoryGetDevices.current.satellites"><div class="col-5">Спутников:</div><div class="col-7">{{factoryGetDevices.current.satellites}}</div></div><div class="row" ng-if="factoryGetDevices.current._dateTime"><div class="col-5">Дата:</div><div class="col-7">{{ (factoryGetDevices.current._dateTime || null ) | date:\'yyyy.MM.dd\'}} {{ (factoryGetDevices.current._dateTime || null ) | date:\'HH:mm:ss\'}}</div></div><div class="row">{{factoryGetDevices.current.lat}} {{factoryGetDevices.current.lng}}</div></div>'),$templateCache.put("item/modal-exit.html",'<div ng-repeat="modal in modals" class="animate-repeat"><div ng-click="modal.close()" class="button-close"></div><div class="content-modal">{{modal.text}}</div><div class="container-buttons-modal"><div class="button" ng-repeat="button in modal.buttons" ng-click="button.action()">{{button.text}}</div></div></div>'),$templateCache.put("item/report-graph.html",'<div><svg report-graph-svg ng-drag="true" drag-reset="false" drag-axis="x" offset-left="{{serviceReport.left}}" height="200" width="100%" ng-repeat="device in arrDeviceCoord" graph-path="device" report-height="reportGraphHeight" report-width="reportGraphWidth"></svg><div class="control-scale-xx"><div>-</div><div ng-click="scalePlus()">+</div></div></div>'),$templateCache.put("item/report-popup.html",'<div><div class="row">{{device.text}}</div><div class="row"><div class="col-6">Дата</div><div class="col-6">{{params._dateString | date:\'dd.MM.yyyy\'}}</div></div><div class="row"><div class="col-6">Время</div><div class="col-6">{{params._dateString | date:\'HH:mm:ss\'}}</div></div><div class="row"><div class="col-6">Cкорость</div><div class="col-6">{{params.speed}}km/h</div></div><div class="row"><div class="col-6">Lat</div><div class="col-6">{{params.lat}}</div></div><div class="row"><div class="col-6">Lng</div><div class="col-6">{{params.lng}}</div></div></div>'),$templateCache.put("item/report.html",'<div ng-controller="reportContrl"><div class="title">Отчет<div class="button-close" ng-click="serviceShowElements.showReport = !serviceShowElements.showReport"></div></div><div class="row"><div class="col-4">Дата</div><div class="col-8"><calendar after="serviceReport.after" before="serviceReport.before" link="true"></calendar></div></div><div class="row"><div class="col-4"><span>Устройство</span></div><div class="col-8"><select ng-model="currentImei" ng-options="device.imei as device.text for device in devices" ng-change="changeCurrent()"></select></div></div><div class="row"><div class="col-4"><span>Предел km/h</span></div><div class="col-8"><input type="number" ng-model="factoryGetOptions.limitSpeed"></div></div><div class="row"><div class="col-4"><span>Шаг точек</span></div><div class="col-8"><input type="number" ng-model="factoryGetOptions.stepPoints"></div></div><div class="row"><div class="col-4"><span>График</span></div><div class="col-8"><input type="checkbox" ng-model="serviceShowElements.reportGraph"></div></div><div class="row container-buttons"><div class="button" ng-click="showTrack()">Отобразить</div><div class="button">Сохранить</div><div class="button" ng-click="hideTrack()">Скрыть</div></div><div class="row" ng-if="devices.current._maxSpeed"><div class="col-6">Max скорость</div><div class="col-6">{{devices.current._maxSpeed}}</div></div><div class="row" ng-if="devices.current._points"><div class="col-6"><span>Количество точек</span></div><div class="col-6">{{devices.current._points.length}}</div></div></div>'),$templateCache.put("item/setting-options.html",'<div class="button-close" ng-click="settingsShow()"></div><div><div class="title">Настройки</div><div class="row"><div class="col-6">Тип карты</div><div class="col-6"><select ng-model="data.map" ng-options="map.map as map.text for map in arrMapType"></select></div></div><div class="row"><div class="col-6">Часовой пояс</div><div class="col-6"><select ng-model="data.timeZone" ng-options="time.text as time.text for time in timeZones"></select></div></div><div class="row"><div class="col-6">Локация карты</div><div class="col-6"><div class="opta">{{data.lat}} {{data.lng}}</div></div></div><div class="row"><div class="col-6">Отображать доп. инфо</div><div class="col-6"><input type="checkbox" style="width: 16px" ng-model="serviceShowElements.showInfo"></div></div><div class="title">Устройства</div><div></div><div ng-repeat="device in factoryGetDevices | orderBy:\'text\'" class="row device-row"><div class="col-1"><input type="checkbox" ng-model="checkbox[$index]" ng-change="checkboxChange($index, device.imei)"></div><div class="col-4"><input ng-model="device.text" type="text"></div><div class="col-4"><input ng-model="device.imei" valid="int" type="text" readonly></div><div class="col-3"><input ng-model="device.phone" type="text"></div></div><div class="row device-row"><div class="col-1">&nbsp</div><div class="col-4"><input ng-model="newDevice.text" class="text"></div><div class="col-4"><input ng-model="newDevice.imei" valid="int" class="text"></div><div class="col-3"><input ng-model="newDevice.phone" class="text"></div></div><div class="alert-row text-center" ng-class="alertShow">{{alertMess}}</div><div class="container-buttons-modal"><div class="button" ng-click="addDevise()">Добавить</div><div class="button" ng-click="delDevice()">Удалить</div></div></div>'),$templateCache.put("item/test.html",'<svg height="200" width="100%" ng-repeat="device in arrDeviceCoord" class="ng-scope"><!--<path d="M150 0 L75 200 L225 100"></path>--><!-- ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M239 29L239 29" stroke="red" stroke-width="3" fill="none" graph-path="" sx="239" sy="29" ex="239" ey="30" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M239 30L240 30" stroke="red" stroke-width="3" fill="none" graph-path="" sx="239" sy="30" ex="240" ey="32" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 32L240 32" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="32" ex="240" ey="33" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 33L240 33" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="33" ex="240" ey="37" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 37L240 37" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="37" ex="240" ey="38" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 38L240 38" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="38" ex="240" ey="39" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 39L240 39" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="39" ex="240" ey="38" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 38L240 38" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="38" ex="240" ey="36" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 36L240 36" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="36" ex="240" ey="37" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 37L240 37" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="37" ex="240" ey="35" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 35L240 35" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="35" ex="240" ey="33" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 33L240 33" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="33" ex="240" ey="36" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 36L240 36" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="36" ex="240" ey="35" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 35L240 35" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="35" ex="240" ey="36" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><g ng-repeat="k in device" class="ng-scope"><path d="M240 36L240 36" stroke="red" stroke-width="3" fill="none" graph-path="" sx="240" sy="36" ex="240" ey="36" class="ng-isolate-scope"></path></g><!-- end ngRepeat: k in device --><!-- end ngRepeat: k in device --></svg>')}]),app.controller("modalCntrl",function(){}),app.controller("maskContrl",function(){}),app.controller("settingOptionsContr",function(timeZone,$interval,$http,srvModal,$timeout,map,$scope,factorySettingOptions,factoryGetOptions,tileLayers,factoryGetDevices,serviceShowElements){function empty(val){return val?/^\s*$/.test(val)?!0:!1:!0}function textMapDecode(map){switch(map){case"ggl":return"Google";case"osm":return"OSM";case"mapia":return"Mapia";case"osmVelo":return"Velo";case"huma":return"Humanitarian‎";default:return""+map}}function clearAlert(){$timeout(function(){$scope.alertShow="",$scope.alertMess=""},7e3)}$scope.factorySettingOptions=factorySettingOptions,$scope.data=factoryGetOptions,$scope.factoryGetDevices=factoryGetDevices,$scope.selectMap=factoryGetOptions.map,$scope.timeZone=factoryGetOptions.timeZone,$scope.timeZones=timeZone,$scope.arrMapType=[],$scope.map=map.map,$scope.checkbox=[],$scope.newDevice={},$scope.serviceShowElements=serviceShowElements;var selectDevice;$scope.settingsShow=function(){$scope.factorySettingOptions.show=!$scope.factorySettingOptions.show},$scope.checkboxChange=function(N,_id){for(var i=0;i<$scope.checkbox.length;i++)i!=N&&($scope.checkbox[i]=!1);selectDevice=$scope.checkbox[N]?_id:null};for(var opt in tileLayers)$scope.arrMapType.unshift({map:opt,text:textMapDecode(opt)});$scope.$watch("data.timeZone",function(){}),$scope.delHttp=function(){$timeout(function(){for(var i=0;i<$scope.factoryGetDevices.length;i++)if($scope.factoryGetDevices[i].imei==selectDevice){$interval.cancel($scope.factoryGetDevices[i]._timer),$scope.factoryGetDevices.splice(i,1),selectDevice=null;for(var i=0;i<$scope.checkbox.length;i++)$scope.checkbox[i]=!1}},2e3)},$scope.delDevice=function(){selectDevice&&srvModal.addModal({text:"Удалить устройство "+selectDevice+"?",buttons:[{text:"Ok",action:$scope.delHttp},{text:"No",action:function(){}}]})},$scope.httpAddDevise=function(){var data={name:$scope.newDevice.text,imei:$scope.newDevice.imei,phone:$scope.newDevice.phone?$scope.newDevice.phone:""};$http.post("php/add-device.php",data).success(function(d){switch(d){case"OK":$scope.factoryGetDevices.push({text:$scope.newDevice.text,imei:$scope.newDevice.imei,phone:$scope.newDevice.phone});for(var opt in $scope.newDevice)$scope.newDevice[opt]=null;break;case"EXIST_CURRENT":$scope.alertShow="show",$scope.alertMess="Устройство зарегистрированно ранее",clearAlert();break;case"EXIST_OTHER":$scope.alertShow="show",$scope.alertMess="Устройство зарегистрированно на другого пользователя",clearAlert()}console.log(d)}).error(function(d){console.log(d)})},$scope.addDevise=function(){return empty($scope.newDevice.imei)?($scope.alertShow="show",$scope.alertMess="Идентификатор устройства должен быть определен",void clearAlert()):$scope.newDevice.imei&&$scope.newDevice.imei.length<10?($scope.alertShow="show",$scope.alertMess="Идентификатор устройства должен содержать не менее 10 цифр",void clearAlert()):empty($scope.newDevice.text)?($scope.alertShow="show",$scope.alertMess="Имя устройства не может быть пустым",void clearAlert()):void $scope.httpAddDevise()},$scope.settingsDone=function(){console.log($scope.checkbox)}}),app.controller("objectsContrl",function($scope,$interval,$timeout,factoryGetDevices,map,factoryGetOptions,factoryFormatDate,factoryMarker,canvasRender){function init(){getParms++,getParms>1&&(refacto(),console.log($scope.factoryGetOptions.timeZone))}function refacto(){function interval(_i){function setDif(){$scope.factoryGetDevices[i]._elapsedTime=(new Date).getTime()-$scope.factoryGetDevices[i]._dateTime}var i=_i;return $interval(setDif,1e3)}for(var i=0;i<$scope.factoryGetDevices.length;i++)$scope.factoryGetDevices[i]._dateTime=setDate($scope.factoryGetDevices[i].dateTime,$scope.factoryGetOptions.timeZone),$scope.factoryGetDevices[i]._elapsedTime=null,$scope.factoryGetDevices[i]._timer||(watchers(i),$scope.factoryGetDevices[i]._timer=function(){return interval(i)}())}function watchers(i){$scope.$watch("factoryGetDevices["+i+"].dateTime",function(){$scope.factoryGetDevices[i]&&($scope.factoryGetDevices[i]._dateTime=setDate($scope.factoryGetDevices[i].dateTime,$scope.factoryGetOptions.timeZone),factoryMarker.marker(i))}),$scope.$watch("factoryGetDevices["+i+"]._elapsedTime",function(){var elapsedTime=$scope.factoryGetDevices[i]._elapsedTime,device=$scope.factoryGetDevices[i];device._state=elapsedTime&&6e5>elapsedTime?1<F(device.speed)?"MOVE":"STOP":"NO_SIGNAL"}),$scope.$watch("factoryGetDevices["+i+"]._state",function(){factoryMarker.marker(i)}),$scope.$watch("factoryGetDevices["+i+"]._colorState",function(){var device=factoryGetDevices[i];switch(device._state){case"NO_SIGNAL":device._context&&canvasRender.no_signal(device._context,device._colorState);break;case"STOP":device._context&&canvasRender.stop(device._context,device._colorState)}})}$scope.factoryGetDevices=factoryGetDevices,$scope.factoryGetOptions=factoryGetOptions,$scope.current={},$scope.map=map.map;var getParms=0,F=parseFloat,setDate=factoryFormatDate.stringToGetTime;$scope.setCurrent=function(imei){for(var i=0;i<$scope.factoryGetDevices.length;i++)if($scope.factoryGetDevices[i].imei==imei){$scope.current=$scope.factoryGetDevices[i],factoryGetDevices.current=factoryGetDevices[i],$scope.current.lat&&$scope.current.lng&&$scope.map.setView([F($scope.current.lat),F($scope.current.lng)]);break}},$scope.$watch("factoryGetOptions.timeZone",function(){$scope.factoryGetOptions.timeZone&&init()}),$scope.$watch("factoryGetDevices.length",function(){$scope.factoryGetDevices.length&&init()})}),app.controller("footerContrl",function($scope,factoryGetOptions){$scope.factoryGetOptions=factoryGetOptions}),app.controller("mapCntrl",function($scope,factoryGetOptions,tileLayers,map,factoryGetDevices){function initMap(){$scope.map.setView([$scope.factoryGetOptions.lat,$scope.factoryGetOptions.lng],$scope.factoryGetOptions.zoom),$scope.map.dragging.enable(),$scope.map.on("move",$scope.location),$scope.map.on("mousemove",$scope.mouseLocation)}var load=!1;$scope.ll="44",$scope.map=map.map,map.scope.factoryGetDevices=factoryGetDevices,$scope.factoryGetOptions=factoryGetOptions,$scope.$watch("factoryGetOptions.map",function(){$scope.factoryGetOptions.map&&($scope.setBaseLayer($scope.factoryGetOptions.map),tileLayers[$scope.factoryGetOptions.map].addTo($scope.map),!load&&initMap(),load=!0)}),$scope.mouseLocation=function(e){$scope.factoryGetOptions.mouselat=e.latlng.lat.toFixed(5),$scope.factoryGetOptions.mouselng=e.latlng.lng.toFixed(5),$scope.$apply()},$scope.location=function(){$scope.factoryGetOptions.lat=$scope.map.getCenter().lat.toFixed(5),$scope.factoryGetOptions.lng=$scope.map.getCenter().lng.toFixed(5)},$scope.$watch("factoryGetOptions.lat"),$scope.setBaseLayer=function(type){tileLayers[type].addTo($scope.map);for(var opt in tileLayers)opt!=type&&$scope.map.removeLayer(tileLayers[opt])}}),app.controller("headContrl",function($scope,srvModal,factorySettingOptions,$http,serviceShowElements){$scope.item={},$scope.factorySettingOptions=factorySettingOptions,$scope.show=function(name){$scope.item[name]="show"==$scope.item[name]?"":"show"},$scope.serviceShowElements=serviceShowElements,$scope.exitHttp=function(){$http.post("php/exit.php").success(function(d){switch(d.status){case"OK":window.location=d.path;break;default:console.log(d)}}).error(function(d){console.log(d)})},$scope.exit=function(){srvModal.addModal({text:"Выйти из системы?",buttons:[{text:"Ok",action:$scope.exitHttp},{text:"No"}]})},$scope.settingsShow=function(){$scope.factorySettingOptions.show=!$scope.factorySettingOptions.show}}),app.controller("reportContrl",["$scope","serviceShowElements","factoryGetDevices","factoryFormatDate","$http","$filter","map","factoryReportMarker","factoryGetOptions","serviceReport",function($scope,serviceShowElements,factoryGetDevices,factoryFormatDate,$http,$filter,map,factoryReportMarker,factoryGetOptions,serviceReport){function trackAddToMap(device){var orderBy=$filter("orderBy"),limit=$filter("limitTo"),myFilter=$filter("myFilter"),d=device._trackPoints,arr=orderBy(d,"dateTime"),arrP=myFilter(arr,factoryGetOptions.stepPoints);d&&d.length&&(device._maxSpeed=limit(orderBy(d,function(el){return F(el.speed)},!0),1)[0].speed),d&&d.length&&(device._points=d);var markers=factoryReportMarker.addMarker(arrP,device),pointList=setArrLatLngs(arr),polilyne=L.polyline(pointList,{color:"blue",weight:10,opacity:.3,smoothFactor:1}),patterns=[{offset:"5%",repeat:"100px",symbol:new L.Symbol.ArrowHead({pixelSize:10,headAngle:45,polygon:!1,pathOptions:{stroke:!0,weight:2,color:"#0024ff",opacity:"0.9"}})}],arrowHead=L.polylineDecorator(polilyne,{patterns:patterns});device._trackGroup&&map.map.removeLayer(device._trackGroup);for(var group=[arrowHead,polilyne],i=0;i<markers.length;i++)group.push(markers[i]);device._trackGroup=L.featureGroup(group),device._trackGroup.addTo(map.map)}function setArrLatLngs(arr){for(var arrLatLngs=[],i=0;i<arr.length;i++)arr[i].lat&&"null"!=arr[i].lat&&arrLatLngs.push([F(arr[i].lat),F(arr[i].lng)]);return arrLatLngs}$scope.serviceShowElements=serviceShowElements;var F=parseFloat,d=new Date;$scope.serviceReport=serviceReport,$scope.serviceReport.before=new Date(d.getFullYear(),d.getMonth(),d.getDate()),$scope.serviceReport.after=new Date(d.getFullYear(),d.getMonth(),d.getDate()),$scope.devices=factoryGetDevices,$scope.current,$scope.factoryGetOptions=factoryGetOptions,$scope.$watch("devices.current",function(){$scope.devices.current&&($scope.currentImei=$scope.devices.current.imei)}),$scope.changeCurrent=function(){},$scope.$watch("currentImei",function(newVal){factoryGetDevices.current.imei!=newVal&&($scope.devices.current=function(){for(var i=0;i<factoryGetDevices.length;i++)if(factoryGetDevices[i].imei==newVal)return factoryGetDevices[i]}())}),$scope.showTrack=function(){if($scope.devices&&$scope.devices.current&&$scope.devices.current.imei){var b=$scope.serviceReport.before,before=new Date(b.getFullYear(),b.getMonth(),b.getDate()+1),from=factoryFormatDate.dateToString($scope.serviceReport.after),to=factoryFormatDate.dateToString(before);$http.post("php/showTrack.php",{imei:$scope.devices.current.imei,from:from,to:to}).success(function(d){$scope.devices.current._trackPoints=d,d&&d.length&&(factoryGetOptions.stepPoints=Math.ceil(d.length/200));for(var i=0;i<$scope.devices.length;i++)$scope.devices[i]._trackPoints&&trackAddToMap($scope.devices[i])})}},$scope.$watchCollection("[factoryGetOptions.limitSpeed,factoryGetOptions.stepPoints]",function(){for(var i=0;i<$scope.devices.length;i++)$scope.devices[i]._trackPoints&&trackAddToMap($scope.devices[i])
}),$scope.hideTrack=function(){$scope.devices.current._trackGroup&&map.map.removeLayer($scope.devices.current._trackGroup),$scope.devices.current._maxSpeed&&delete $scope.devices.current._maxSpeed,$scope.devices.current._points&&delete $scope.devices.current._points,$scope.devices.current._trackPoints&&delete $scope.devices.current._trackPoints}}]).filter("myFilter",function(){return function(input,n,link){if(link){for(var k=0,end=input.length/n;end>k;)input.splice(k,n-1),k++;return input}for(var arr=[],i=0;i<input.length;i++)(i%n==0||i==input.length-1)&&arr.push(input[i]);return arr}}),app.controller("graphContrl",["$scope","factoryGetDevices","serviceReport","factoryGetOptions",function($scope,factoryGetDevices,serviceReport,factoryGetOptions){function watchers(i){$scope.$watch("factoryGetDevices["+i+"]._points",function(val){toCoord(val,i)}),$scope.$watch("serviceReport.before",function(val){console.log(val)}),$scope.$watch("factoryGetOptions.limitSpeed",function(){for(var i=0;i<$scope.factoryGetDevices.length;i++)toCoord($scope.factoryGetDevices[i]._points,i)})}function toCoord(arr,_i){if(arr){var yy=$scope.reportGraphHeight,xx=$scope.reportGraphWidth,from=$scope.serviceReport.after.getTime(),to=$scope.serviceReport.before.getTime()+864e5,k=xx/(to-from),ky=F(yy/$scope.factoryGetOptions.limitSpeed);$scope.arrDeviceCoord[_i]=[];var koord=$scope.arrDeviceCoord[_i];koord[0]={x:(k*(arr[0]._dateString-from)).toFixed(0).f(),y:yy};for(var i=0;i<arr.length;i++)koord.push({x:(k*(arr[i]._dateString-from)).toFixed(0).f(),y:yy-ky*arr[i].speed.f()});koord.push({x:(k*(arr[arr.length-1]._dateString-from)).toFixed(0).f(),y:yy}),console.log($scope.arrDeviceCoord[_i])}}$scope.factoryGetDevices=factoryGetDevices,$scope.serviceReport=serviceReport,$scope.factoryGetOptions=factoryGetOptions,$scope.arrDeviceCoord=[],$scope.scalePlus=function(){$scope.serviceReport.scale=2*$scope.serviceReport.scale};for(var i=0;i<$scope.factoryGetDevices.length;i++)watchers(i);$scope.$watch("reportGraphWidth",function(){for(var i=0;i<$scope.factoryGetDevices.length;i++)toCoord($scope.factoryGetDevices[i]._points,i)}),$scope.dragEnd=function(){alert("dd")}}]),app.service("srvModal",function(){function setArray(obj,n){function add(_i){var i=_i;arr[i]={text:_arr[i].text,action:function(){delModal(n),_arr[i].action&&_arr[i].action()}}}for(var arr=[],_arr=obj.buttons,i=0;i<_arr.length;i++)add(i);return arr}function delModal(n){for(var i=0;i<arr.length;i++)if(n==arr[i].$N){arr.splice(i,1),0==arr.length&&(s.maskScope.show=!1);break}}var arr=[],N=0,s=this;this.url="item/modal-exit.html",this.addModal=function(_obj){s.maskScope.show=!0;var obj={};obj.buttons=[],obj.close=function(){var n=N;return function(){delModal(n)}}(),obj.text=_obj.text,obj.buttons=setArray(_obj,N),obj.$N=N,arr.unshift(obj),s.scope.show=!0,s.scope.modals=arr,N++}}),app.service("serviceShowElements",function(){this.showInfo=!0,this.showElapsedPost=!1,this.showReport=!1,this.reportGraph=!1}),app.service("serviceReport",function(){this.before,this.after,this.scale=1,this.left=0}),app.directive("mainMap",function(windowSize,map){return{restrict:"C",link:function(scope,el){el.css("height",document.body.clientHeight+"px"),map.scope=scope}}}),app.directive("blockItem",function(windowSize){var height=windowSize.height-30;return{restrict:"C",link:function(scope,el){el.css("height",height+"px")}}}),app.directive("modal",function(srvModal){return{restrict:"E",templateUrl:srvModal.url,link:function(scope){srvModal.scope=scope}}}),app.directive("mask",function(windowSize,srvModal){return{restrict:"E",link:function(scope,el){srvModal.maskScope=scope,el.css("height",windowSize.height+"px")}}}),app.directive("settingOptions",function(){return{restrict:"C",templateUrl:"item/setting-options.html",link:function(scope,el){el.css("display","block")}}}),app.directive("valid",function(factoryValid){var valid=factoryValid;return{restrict:"A",require:"ngModel",link:function(scope,element,attr,ngModelCtrl){function fromUser(text){var transformedInput=valid[name](text);return transformedInput!==text&&(ngModelCtrl.$setViewValue(transformedInput),ngModelCtrl.$render()),transformedInput}var name=attr.valid;ngModelCtrl.$parsers.push(fromUser)}}}),app.directive("stateObj",function(){var F=parseFloat;return{restrict:"EA",scope:{device:"=device",elapsedTime:"=elapsedTime"},controller:function($scope,$element){function color(milSec){var _color="white";if(milSec){if(6e5>milSec)_color="MOVE"==$scope.device._state?"#8080FF":"#68FF49";else if(864e5>milSec){var c=255*milSec/864e5;c=parseInt(c),_color="rgb(255,255,"+c+")"}}else _color="white";return $scope.device._colorState=_color,_color}function state(){$scope.device._state=$scope.elapsedTime&&$scope.elapsedTime<6e5?1<F($scope.device.speed)?"MOVE":"STOP":"NO_SIGNAL"}$scope.$watch("elapsedTime",function(){state(),$element.css("backgroundColor",color($scope.elapsedTime))})},link:function(scope,el){el.css("width","12px"),el.css("height","12px"),el.css("display","inline-block"),el.css("boxShadow","1px 1px 2px rgba(0,0,0,0.4)"),el.css("margin","2px"),el.css("borderRadius","50%"),el.css("border","1px solid #003300"),el.css("transition","0.3s")}}}),app.directive("infoobject",["$compile","factoryGetDevices","serviceShowElements",function($compile,factoryGetDevices,serviceShowElements){return{restrict:"EA",replace:!0,controller:function($scope){$scope.serviceShowElements=serviceShowElements,$scope.factoryGetDevices=factoryGetDevices},templateUrl:"item/info-object.html"}}]),app.directive("marker",function(canvasRender){return{restrict:"EA",scope:{name:"@name",device:"=device"},replace:!0,template:'<canvas width="30" height="30"></canvas>',controller:function($scope,$element){var canvas=$element[0],context=canvas.getContext("2d");switch($scope.device._context=context,$scope.device._state){case"MOVE":canvasRender.move(context,$scope.device.azimuth);break;case"NO_SIGNAL":canvasRender.no_signal(context,$scope.device._colorState);break;case"STOP":canvasRender.stop(context,$scope.device._colorState)}}}}),app.directive("elapsedpost",function(factoryGetDevices){return{restrict:"E",replace:!0,templateUrl:"item/elapsed-post.html",controller:function($scope,$element){$scope.factoryGetDevices=factoryGetDevices,this.el=$element}}}).directive("tik",function(){return{restrict:"A",require:"^elapsedpost",link:function($scope,$element,attr,elapsedpost){$scope.$watch("seconds",function(){5e3<$scope.millis?elapsedpost.el.css("color","red"):elapsedpost.el.css("color","white")})}}}),app.directive("report",function(){return{restrict:"C",templateUrl:"item/report.html",link:function(scope,el){el.css("display","inherit")}}}),app.directive("markerReport",["map","$compile","factoryGetDevices","$timeout",function(map,$compile,factoryGetDevices,$timeout){function getDevice(imei){for(var i=0;i<factoryGetDevices.length;i++)if(factoryGetDevices[i].imei==imei)return factoryGetDevices[i]}var f=parseFloat;return{restrict:"AE",scope:{markerReport:"@"},link:function($scope,$element){function setPopup(){var text="<reportpopup></reportpopup>",linkFn=$compile(text),content=linkFn($scope),popup=L.popup({offset:[0,-10],minWidth:120}).setLatLng([f($scope.params.lat),f($scope.params.lng)]).setContent(content[0]);return popup}var popup;$scope.params=JSON.parse($scope.markerReport),$scope.device=getDevice($scope.params.imei);var timeout;$element.on("click",function(){popup=setPopup().addTo($scope.device._trackGroup)}).on("mouseenter",function(){popup||(popup=setPopup().addTo($scope.device._trackGroup),timeout&&$timeout.cancel(timeout))}).on("mouseleave",function(){timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){popup&&($scope.device._trackGroup.removeLayer(popup),popup=null)},2e3)})}}}]).directive("reportpopup",function(){return{restrict:"EA",templateUrl:"item/report-popup.html",replace:!0}}),app.directive("reportGraph",["serviceShowElements","serviceReport",function(serviceShowElements,serviceReport){return{restrict:"C",templateUrl:"item/report-graph.html",controller:"graphContrl",link:function(scope,el){scope.serviceReport=serviceReport,scope.serviceShowElements=serviceShowElements,scope.reportGraphHeight=el[0].clientHeight,scope.reportGraphWidth=serviceReport.scale*window.document.body.clientWidth,scope.$watch("serviceReport.scale",function(){scope.reportGraphWidth=serviceReport.scale*window.document.body.clientWidth});angular.element(document.body)}}}]),app.directive("reportGraphSvg",["serviceReport",function(serviceReport){return{restrict:"A",scope:{graphPath:"=",reportHeight:"=",reportWidth:"=",offsetLeft:"@"},replace:!1,link:function(scope,el){scope.graphPath,scope.serviceReport=serviceReport;var template="";if(el.css("height",scope.reportHeight+"px"),el.css("width",scope.reportWidth+"px"),el.css("left",scope.offsetLeft+"px"),angular.isArray(scope.graphPath)){for(var i=0;i<scope.graphPath.length;i++)for(var string="M"+scope.graphPath[0].x+" "+scope.graphPath[0].y,i=1;i<scope.graphPath.length;i++){{var ks=scope.graphPath[i];scope.graphPath[i+1]}ks.x&&(string+=" L"+ks.x+" "+ks.y)}template='<path d="'+string+'" fill="white" stroke="red" />',el.html(template)}scope.$watch(function(){return el.attr("offset-left")},function(val){serviceReport.left=val})}}}]),app.factory("factorySettingOptions",function(){return{show:!1}}),app.factory("factoryGetOptions",function($timeout,$http){var params={};return $http.post("php/get-options.php",null).success(function(d){params.map=d.mapType,params.timeZone=d.timeZone,params.zoom=d.startZoom,params.lat=d.startLat,params.lng=d.startLng,params.mouselat=null,params.mouselng=null,params.limitSpeed=100,params.stepPoints=1,console.log("mess from factory "+params.map)}).error(function(d){console.log("Error get opt "+d)}),params}),app.factory("factoryGetDevices",function($timeout,$http,$interval){function existEl(imei){if(!imei)return!1;for(var i=0;i<devices.length;i++)if(devices[i].imei==imei)return!0;return!1}function replaceParam(newObj){for(var i=0;i<devices.length;i++)if(devices[i]&&devices[i].imei&&devices[i].imei==newObj.imei){var devObj=devices[i];for(var opt in newObj)newObj[opt]!=devObj[opt]&&"phone"!=opt&&"text"!=opt&&(devObj[opt]=newObj[opt],console.log(opt))}}function reqParm(){$http.post("php/get-devices.php",null).success(function(d){if(devices.timePost=(new Date).getTime(),isArray(d))for(var i=0;i<d.length;i++)existEl(d[i].imei)?replaceParam(d[i]):devices.push(d[i])}).error(function(d){console.log(d)})}var devices=[];devices.current={},devices.timePost=null;var isArray=angular.isArray;return reqParm(),$interval(reqParm,5e3),devices}),app.factory("factoryValid",function(){var valid={"int":function(text){var t=text.replace(/[^0-9]/g,"");return t}};return valid}),app.factory("factoryFormatDate",function(factoryGetOptions){function stringToGetTime(string,offset){offset&&(offset=parseFloat(offset)),offset=offset||parseFloat(factoryGetOptions.timeZone);var arr=(""+string).split(""),yy=""+arr[0]+arr[1],mm=""+arr[2]+arr[3];mm=parseFloat(mm),mm--;var dd=""+arr[4]+arr[5],hh=""+arr[6]+arr[7];hh=parseFloat(hh)+(offset?offset:0);var mi=""+arr[8]+arr[9],ss=""+arr[10]+arr[11],date=new Date("20"+yy,mm,dd,hh,mi,ss);return date.getTime()}function dateToString(d){var newDate=new Date(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours()-parseFloat(factoryGetOptions.timeZone));return angular.format.date(newDate,"yyMMddHHmmss")}return{stringToGetTime:stringToGetTime,dateToString:dateToString}}),app.factory("factoryMarker",function(factoryGetDevices,map,$compile){function divIcon(i){var template='<marker name="'+factoryGetDevices[i].text+'" device="factoryGetDevices['+i+']"></marker>',linkFn=(document.createElement("canvas"),$compile(template)),content=linkFn(map.scope),icon=L.divIcon({className:"my-div",iconAnchor:[15,15],html:content});return icon}function marker(i){return devices[i]._marker&&map.map.removeLayer(devices[i]._marker),devices[i]._popup&&map.map.removeLayer(devices[i]._popup),devices[i]._marker=L.marker([f(devices[i].lat),f(devices[i].lng)],{icon:divIcon(i)}).addTo(map.map),devices[i]._popup=L.popup({offset:[0,-10]}).setLatLng([f(devices[i].lat),f(devices[i].lng)]).setContent(devices[i].text).addTo(map.map),marker}var f=parseFloat,devices=factoryGetDevices;return{marker:marker}}),app.factory("canvasRender",function(){function getRadianAngle(degreeValue){return degreeValue*Math.PI/180}function move(context,azimuth){context.clearRect(0,0,30,30),context.translate(15,15),context.rotate(getRadianAngle(parseFloat(azimuth))),context.beginPath(),context.moveTo(0,-13),context.lineTo(7,5),context.lineTo(0,3),context.lineTo(-7,5),context.fillStyle="#8080FF",context.fill(),context.closePath(),context.lineWidth=1,context.strokeStyle="#003300",context.stroke(),console.log(azimuth+" degree")}function stop(context,color){context.clearRect(0,0,30,30),context.beginPath(),context.arc(15,15,7,0,2*Math.PI,!1),context.fillStyle=color,context.fill(),context.lineWidth=1,context.strokeStyle="#003300",context.stroke(),console.log("stop:"+color)}function no_signal(context,color){context.clearRect(0,0,30,30),context.beginPath(),context.arc(15,15,7,0,2*Math.PI,!1),context.fillStyle=color,context.fill(),context.lineWidth=1,context.strokeStyle="#003300",context.stroke(),console.log("no_signal:"+color)}return{move:move,stop:stop,no_signal:no_signal}}),app.factory("factoryReportMarker",["$compile","map","factoryGetOptions","factoryFormatDate",function($compile,map,factoryGetOptions,factoryFormatDate){function getRadianAngle(degreeValue){return degreeValue=f(degreeValue),degreeValue*Math.PI/180}function render(context,parms){var color=getColor(parms.speed);parms.speed&&0<f(parms.speed)?(context.translate(10,10),context.rotate(getRadianAngle(parseFloat(parms.azimuth))),context.beginPath(),context.moveTo(0,-5),context.lineTo(4,5),context.lineTo(-4,5),context.fillStyle=color,context.fill(),context.closePath(),context.lineWidth=1,context.strokeStyle="#003300",context.stroke()):(context.clearRect(0,0,20,20),context.beginPath(),context.arc(10,10,5,0,2*Math.PI,!1),context.fillStyle=color,context.fill(),context.lineWidth=1,context.strokeStyle="#003300",context.stroke())}function getColor(speed){var limit=f(factoryGetOptions.limitSpeed),step=limit/5;speed=f(speed);var c,s;return step>speed?(c=255-255/step*speed,c=c.toFixed(0),"rgb("+c+",255,0)"):2*step>speed?(s=speed-step,c=255/step*s,c=c.toFixed(0),"rgb(0,255,"+c+")"):3*step>speed?(s=speed-2*step,c=255-255/step*s,c=c.toFixed(0),"rgb(0,"+c+",255)"):4*step>speed?(s=speed-3*step,c=255/step*s,c=c.toFixed(0),"rgb("+c+",0,255)"):5*step>speed?(s=speed-4*step,c=255-255/step*s,c=c.toFixed(0),"rgb(255,0,"+c+")"):"rgb(255,0,0)"}function divIcon(parms,device){parms.imei=device.imei,parms.name=device.text;var dateString=factoryFormatDate.stringToGetTime(parms.dateTime);parms._time=angular.format.date(new Date(dateString),"HH:mm:ss"),parms._date=angular.format.date(new Date(dateString),"dd:MM:yyyy"),parms._dateString=dateString;var stringParrams=JSON.stringify(parms),template='<canvas width="20" height="20" marker-report='+stringParrams+"></canvas>",linkFn=$compile(template),content=linkFn(map.scope),context=content[0].getContext("2d");render(context,parms);var icon=L.divIcon({className:"my-div",iconAnchor:[10,10],html:content});return icon}function addMarker(arr,device){for(var arrMarkers=[],i=0;i<arr.length;i++){var marker=L.marker([f(arr[i].lat),f(arr[i].lng)],{icon:divIcon(arr[i],device)});arrMarkers.push(marker)}return arrMarkers}var f=parseFloat;return{addMarker:addMarker}}]);